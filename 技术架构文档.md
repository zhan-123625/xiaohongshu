# 技术架构与系统设计文档

## 1. 技术栈 (Tech Stack)

### 1.1 服务端 (Server)
- **核心框架**: NestJS (基于 TypeScript 的渐进式 Node.js 框架)
- **语言**: TypeScript
- **数据库**: MySQL 8.0+
- **ORM**: TypeORM (用于对象关系映射)
- **认证授权**: Passport + JWT (JSON Web Token)
- **运行环境**: Node.js v18+

### 1.2 移动端 (Android Client)
- **语言**: Kotlin
- **最低兼容版本**: Android 7.0 (API Level 24)
- **架构模式**: MVVM (Model-View-ViewModel)
- **依赖注入**: Hilt (Google 推荐的 DI 框架)
- **网络请求**: Retrofit 2 + OkHttp 3 + Gson
- **异步处理**: Kotlin Coroutines (协程)
- **图片加载**: Glide
- **UI 组件**: Material Design Components, ConstraintLayout, RecyclerView, ViewBinding
- **导航**: Android Jetpack Navigation Component

### 1.3 后台管理端 (Admin Web)
- **核心框架**: Vue 3 (Composition API)
- **构建工具**: Vite
- **UI 组件库**: Element Plus
- **路由管理**: Vue Router 4
- **HTTP 客户端**: Axios

## 2. 代码结构 (Code Structure)

### 2.1 服务端结构 (`server/src`)
采用 NestJS 标准模块化结构：
- `app.module.ts`: 根模块，聚合所有子模块。
- `main.ts`: 应用入口，配置全局管道、拦截器和 Swagger。
- `auth/`: 认证模块 (登录、注册、JWT 策略)。
- `users/`: 用户模块 (个人信息、关注、粉丝、黑名单)。
- `notes/`: 笔记模块 (发布、推荐流、点赞、收藏)。
- `comments/`: 评论模块。
- `messages/`: 私信模块 (即时通讯)。
- `admin/`: 管理员模块 (数据统计、内容审核)。
- `entities/`: 数据库实体定义 (TypeORM Entity)。
- `common/`: 公共组件 (守卫、过滤器、拦截器)。

### 2.2 Android 客户端结构 (`android/app/src/main/java/com/example/xiaohongshu`)
采用按功能分包 + MVVM 分层结构：
- `api/`: Retrofit 接口定义 (`ApiService`)。
- `data/`: 数据层
    - `model/`: 数据实体类 (User, Note, Comment)。
    - `repository/`: 仓库层，负责数据获取策略 (Repository)。
- `di/`: Hilt 依赖注入模块 (`AppModule`, `NetworkModule`)。
- `ui/`: 界面层 (Fragment + ViewModel)
    - `login/`: 登录注册。
    - `home/`: 首页推荐流。
    - `detail/`: 笔记详情。
    - `publish/`: 发布笔记。
    - `message/`: 消息列表与聊天。
    - `me/`: 个人中心。
    - `user/`: 用户列表 (关注/粉丝)。
- `MainActivity.kt`: 单 Activity 架构容器。

### 2.3 后台管理端结构 (`admin-web/src`)
- `api/`: Axios 封装与接口定义。
- `views/`: 页面组件 (Login, Dashboard, UserManage, NoteAudit)。
- `router/`: 路由配置。
- `App.vue`: 根组件。

## 3. 系统架构设计 (System Architecture)

### 3.1 总体架构
采用经典的 **C/S (Client-Server)** 架构，前后端分离。
- **客户端 (Android)**: 负责 UI 展示、用户交互、本地缓存。通过 RESTful API 与服务端通信。
- **服务端 (NestJS)**: 提供无状态 REST API，处理业务逻辑、数据持久化、权限验证。
- **数据库 (MySQL)**: 存储用户信息、笔记内容、社交关系 (关注/点赞/收藏)、消息记录。

### 3.2 核心流程设计

#### 3.2.1 认证流程
1.  客户端发送手机号/密码至 `/auth/login`。
2.  服务端验证通过后签发 JWT Token。
3.  客户端保存 Token，并在后续所有请求的 Header (`Authorization: Bearer <token>`) 中携带。
4.  服务端通过 `JwtAuthGuard` 拦截器验证 Token 有效性。

#### 3.2.2 推荐流 (Feed)
1.  客户端请求 `/notes/feed`，携带分页参数。
2.  服务端查询数据库，按时间倒序或算法权重排序。
3.  服务端聚合笔记作者信息、点赞数、收藏数。
4.  返回 JSON 数据，客户端通过 `RecyclerView` + `GridLayoutManager` 展示瀑布流。

#### 3.2.3 实时消息 (Messaging)
*当前实现为轮询或即时 HTTP 请求模式，未来可升级为 WebSocket*
1.  发送方调用 `POST /messages`。
2.  服务端保存消息至 `messages` 表，标记 `is_read = false`。
3.  接收方通过 `GET /messages/conversations` 或 `GET /messages/:userId` 拉取新消息。

### 3.3 数据库设计 (ER 简述)
- **User**: 用户基础信息。
- **Note**: 笔记内容，关联 User。
- **Comment**: 评论，关联 Note 和 User，支持自关联 (回复)。
- **Follow**: 关注关系表 (follower_id, following_id)。
- **Like**: 点赞记录 (user_id, note_id)。
- **Collection**: 收藏记录 (user_id, note_id)。
- **Message**: 私信记录 (sender_id, receiver_id)。
- **Block**: 拉黑关系 (blocker_id, blocked_id)。
